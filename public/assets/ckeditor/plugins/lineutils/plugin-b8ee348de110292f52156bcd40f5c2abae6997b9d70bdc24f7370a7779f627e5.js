/**
 * @license Copyright (c) 2003-2014, CKSource - Frederico Knabben. All rights reserved.
 * For licensing, see LICENSE.md or http://ckeditor.com/license
 */
"use strict";!function(){function e(e,t){CKEDITOR.tools.extend(this,{editor:e,editable:e.editable(),doc:e.document,win:e.window},t,!0),this.frame=this.win.getFrame(),this.inline=this.editable.isInline(),this.target=this[this.inline?"editable":"doc"]}function t(e,t){CKEDITOR.tools.extend(this,t,{editor:e},!0)}function n(e,t){var n=e.editable();CKEDITOR.tools.extend(this,{editor:e,editable:n,doc:e.document,win:e.window,container:CKEDITOR.document.getBody(),winTop:CKEDITOR.document.getWindow()},t,!0),this.hidden={},this.visible={},this.inline=n.isInline(),this.inline||(this.frame=this.win.getFrame()),this.queryViewport();var i=CKEDITOR.tools.bind(this.queryViewport,this),a=CKEDITOR.tools.bind(this.hideVisible,this),o=CKEDITOR.tools.bind(this.removeAll,this);n.attachListener(this.winTop,"resize",i),n.attachListener(this.winTop,"scroll",i),n.attachListener(this.winTop,"resize",a),n.attachListener(this.win,"scroll",a),n.attachListener(this.inline?n:this.frame,"mouseout",function(e){var t=e.data.$.clientX,n=e.data.$.clientY;this.queryViewport(),(t<=this.rect.left||t>=this.rect.right||n<=this.rect.top||n>=this.rect.bottom)&&this.hideVisible(),(0>=t||t>=this.winTopPane.width||0>=n||n>=this.winTopPane.height)&&this.hideVisible()},this),n.attachListener(e,"resize",i),n.attachListener(e,"mode",o),e.on("destroy",o),this.lineTpl=new CKEDITOR.template(u).output({lineStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},d,this.lineStyle,!0)),tipLeftStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},c,{left:"0px","border-left-color":"red","border-width":"6px 0 6px 6px"},this.tipCss,this.tipLeftStyle,!0)),tipRightStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},c,{right:"0px","border-right-color":"red","border-width":"6px 6px 6px 0"},this.tipCss,this.tipRightStyle,!0))})}function i(e,t){return e&t}function a(e){return e&&e.type==CKEDITOR.NODE_ELEMENT}function o(e){return!(!m[e.getComputedStyle("float")]&&!m[e.getAttribute("align")])}function r(e){return!!p[e.getComputedStyle("position")]}function l(e){return a(e)&&"true"==e.getAttribute("contenteditable")}function s(e){return a(e)&&!o(e)&&!r(e)}CKEDITOR.plugins.add("lineutils"),CKEDITOR.LINEUTILS_BEFORE=1,CKEDITOR.LINEUTILS_AFTER=2,CKEDITOR.LINEUTILS_INSIDE=4,e.prototype={start:function(e){var t,n,i,a=this,o=this.editor,r=this.doc,l=CKEDITOR.tools.eventsBuffer(50,function(){o.readOnly||"wysiwyg"!=o.mode||(a.relations={},t=new CKEDITOR.dom.element(r.$.elementFromPoint(n,i)),a.traverseSearch(t),isNaN(n+i)||a.pixelSearch(t,n,i),e&&e(a.relations,n,i))});this.listener=this.editable.attachListener(this.target,"mousemove",function(e){n=e.data.$.clientX,i=e.data.$.clientY,l.input()}),this.editable.attachListener(this.inline?this.editable:this.frame,"mouseout",function(){l.reset()})},stop:function(){this.listener&&this.listener.removeListener()},getRange:function(){var e={};return e[CKEDITOR.LINEUTILS_BEFORE]=CKEDITOR.POSITION_BEFORE_START,e[CKEDITOR.LINEUTILS_AFTER]=CKEDITOR.POSITION_AFTER_END,e[CKEDITOR.LINEUTILS_INSIDE]=CKEDITOR.POSITION_AFTER_START,function(t){var n=this.editor.createRange();return n.moveToPosition(this.relations[t.uid].element,e[t.type]),n}}(),store:function(){function e(e,t,n){var i=e.getUniqueId();i in n?n[i].type|=t:n[i]={element:e,type:t}}return function(t,n){var a;i(n,CKEDITOR.LINEUTILS_AFTER)&&s(a=t.getNext())&&a.isVisible()&&(e(a,CKEDITOR.LINEUTILS_BEFORE,this.relations),n^=CKEDITOR.LINEUTILS_AFTER),i(n,CKEDITOR.LINEUTILS_INSIDE)&&s(a=t.getFirst())&&a.isVisible()&&(e(a,CKEDITOR.LINEUTILS_BEFORE,this.relations),n^=CKEDITOR.LINEUTILS_INSIDE),e(t,n,this.relations)}}(),traverseSearch:function(e){var t,n,i;do if(i=e.$["data-cke-expando"],!(i&&i in this.relations)){if(e.equals(this.editable))return;if(s(e))for(t in this.lookups)(n=this.lookups[t](e))&&this.store(e,n)}while(!l(e)&&(e=e.getParent()))},pixelSearch:function(){function e(e,n,i,a,o){for(var r,l=i,c=0;o(l);){if(l+=a,25==++c)return;if(r=this.doc.$.elementFromPoint(n,l))if(r!=e){if(t(e,r)&&(c=0,s(r=new CKEDITOR.dom.element(r))))return r}else c=0}}var t=CKEDITOR.env.ie||CKEDITOR.env.webkit?function(e,t){return e.contains(t)}:function(e,t){return!!(16&e.compareDocumentPosition(t))};return function(t,n,i){var a=this.win.getViewPaneSize().height,o=e.call(this,t.$,n,i,-1,function(e){return e>0}),r=e.call(this,t.$,n,i,1,function(e){return a>e});if(o)for(this.traverseSearch(o);!o.getParent().equals(t);)o=o.getParent();if(r)for(this.traverseSearch(r);!r.getParent().equals(t);)r=r.getParent();for(;(o||r)&&(o&&(o=o.getNext(s)),o&&!o.equals(r))&&(this.traverseSearch(o),r&&(r=r.getPrevious(s)),r&&!r.equals(o));)this.traverseSearch(r)}}(),greedySearch:function(){this.relations={};for(var e,t,n,i=this.editable.getElementsByTag("*"),a=0;e=i.getItem(a++);)if(!e.equals(this.editable)&&(e.hasAttribute("contenteditable")||!e.isReadOnly())&&s(e)&&e.isVisible())for(n in this.lookups)(t=this.lookups[n](e))&&this.store(e,t);return this.relations}},t.prototype={locate:function(){function e(e,t){var n=e.element[t===CKEDITOR.LINEUTILS_BEFORE?"getPrevious":"getNext"]();return n&&s(n)?(e.siblingRect=n.getClientRect(),t==CKEDITOR.LINEUTILS_BEFORE?(e.siblingRect.bottom+e.elementRect.top)/2:(e.elementRect.bottom+e.siblingRect.top)/2):t==CKEDITOR.LINEUTILS_BEFORE?e.elementRect.top:e.elementRect.bottom}var t,n;return function(a){this.locations={};for(n in a)t=a[n],t.elementRect=t.element.getClientRect(),i(t.type,CKEDITOR.LINEUTILS_BEFORE)&&this.store(n,CKEDITOR.LINEUTILS_BEFORE,e(t,CKEDITOR.LINEUTILS_BEFORE)),i(t.type,CKEDITOR.LINEUTILS_AFTER)&&this.store(n,CKEDITOR.LINEUTILS_AFTER,e(t,CKEDITOR.LINEUTILS_AFTER)),i(t.type,CKEDITOR.LINEUTILS_INSIDE)&&this.store(n,CKEDITOR.LINEUTILS_INSIDE,(t.elementRect.top+t.elementRect.bottom)/2);return this.locations}}(),sort:function(){function e(e){return Math.abs(e-t[a][o])}var t,n,i,a,o,r;return function(l,s){t=this.locations,n=[];for(a in t)for(o in t[a])if(i=e(l),n.length){for(r=0;r<n.length;r++)if(i<n[r].dist){n.splice(r,0,{uid:+a,type:o,dist:i});break}r==n.length&&n.push({uid:+a,type:o,dist:i})}else n.push({uid:+a,type:o,dist:i});return"undefined"!=typeof s?n.slice(0,s):n}}(),store:function(e,t,n){this.locations[e]||(this.locations[e]={}),this.locations[e][t]=n}};var c={display:"block",width:"0px",height:"0px","border-color":"transparent","border-style":"solid",position:"absolute",top:"-6px"},d={height:"0px","border-top":"1px dashed red",position:"absolute","z-index":9999},u='<div data-cke-lineutils-line="1" class="cke_reset_all" style="{lineStyle}"><span style="{tipLeftStyle}">&nbsp;</span><span style="{tipRightStyle}">&nbsp;</span></div>';n.prototype={removeAll:function(){var e;for(e in this.hidden)this.hidden[e].remove(),delete this.hidden[e];for(e in this.visible)this.visible[e].remove(),delete this.visible[e]},hideLine:function(e){var t=e.getUniqueId();e.hide(),this.hidden[t]=e,delete this.visible[t]},showLine:function(e){var t=e.getUniqueId();e.show(),this.visible[t]=e,delete this.hidden[t]},hideVisible:function(){for(var e in this.visible)this.hideLine(this.visible[e])},placeLine:function(e,t){var n,i,a;if(n=this.getStyle(e.uid,e.type)){for(a in this.visible)if(this.visible[a].getCustomData("hash")!==this.hash){i=this.visible[a];break}if(!i)for(a in this.hidden)if(this.hidden[a].getCustomData("hash")!==this.hash){this.showLine(i=this.hidden[a]);break}i||this.showLine(i=this.addLine()),i.setCustomData("hash",this.hash),this.visible[i.getUniqueId()]=i,i.setStyles(n),t&&t(i)}},getStyle:function(e,t){var n,i=this.relations[e],a=this.locations[e][t],o={};if(o.width=i.siblingRect?Math.max(i.siblingRect.width,i.elementRect.width):i.elementRect.width,o.top=this.inline?a+this.winTopScroll.y:this.rect.top+this.winTopScroll.y+a,o.top-this.winTopScroll.y<this.rect.top||o.top-this.winTopScroll.y>this.rect.bottom)return!1;this.inline?o.left=i.elementRect.left:(i.elementRect.left>0?o.left=this.rect.left+i.elementRect.left:(o.width+=i.elementRect.left,o.left=this.rect.left),(n=o.left+o.width-(this.rect.left+this.winPane.width))>0&&(o.width-=n)),o.left+=this.winTopScroll.x;for(var r in o)o[r]=CKEDITOR.tools.cssLength(o[r]);return o},addLine:function(){var e=CKEDITOR.dom.element.createFromHtml(this.lineTpl);return e.appendTo(this.container),e},prepare:function(e,t){this.relations=e,this.locations=t,this.hash=Math.random()},cleanup:function(){var e;for(var t in this.visible)e=this.visible[t],e.getCustomData("hash")!==this.hash&&this.hideLine(e)},queryViewport:function(){this.winPane=this.win.getViewPaneSize(),this.winTopScroll=this.winTop.getScrollPosition(),this.winTopPane=this.winTop.getViewPaneSize(),this.rect=this.inline?this.editable.getClientRect():this.frame.getClientRect()}};var m={left:1,right:1,center:1},p={absolute:1,fixed:1};CKEDITOR.plugins.lineutils={finder:e,locator:t,liner:n}}();